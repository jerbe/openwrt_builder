#=================================================
# Description: Build OpenWrt using GitHub Actions
# Lisence: MIT
# Author: kenzo
#=================================================

name: test

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

env:
  UPLOAD_FIRMWARE: true
  TZ: Asia/Shanghai

jobs:
  build_openwrt:
    runs-on: Ubuntu-20.04
    if: github.event.repository.owner.id == github.event.sender.id
    name: 编译 ${{matrix.target}} 
    strategy:
      fail-fast: false
      matrix:
        target: [xiaomi_redmi-router-ax6s, xiaomi_mi-router-3-pro]
    steps:
    - name: 初始化环境
      run: |
        mkdir firmware
        cd firmware
        echo -e "${{ matrix.target }}" >> ${{ matrix.target }}.txt
        echo -e "${{ matrix.target }}" >> ${{ matrix.target }}.bin
        echo -e "${{ matrix.target }}" >> ${{ matrix.target }}.img
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        sleep `echo $RANDOM|cut -c 1,1|awk '{print $0"s"}'`
    - name: 上传固件到artifact
      uses: actions/upload-artifact@v3
      with:
        name: openwrt_release_firmware
        path: ${{env.FIRMWARE}}
        if-no-files-found: error

  release_openwrt:
    runs-on: Ubuntu-20.04
    needs: build_openwrt
    if: ${{ success()}}
    name: 发布到Release
    steps:
    - name: 下载 Artifact
      uses: actions/download-artifact@v3
      with:
          name: openwrt_release_firmware
          path: openwrt/firmware
    - name: 生成发布信息
      run: |
        echo -e "发布成功\n" >> release.txt
        touch release.txt
    - name: 发布Release
      uses: softprops/action-gh-release@v1
      with:
        files: openwrt/firmware/*
        name: 发布测试数据
        body_path: release.txt
        tag_name: test_tag

        
